---
# multilingual page pair id, this must pair with translations of this page. (This name must be unique)
# lng_pair: id_autogeneratedsamplecontent_1
title: Servletìœ¼ë¡œ Session ì‚¬ìš©í•˜ê¸°

# post specific
# if not specified, .name will be used from _data/owner.yml
#author: "Dante"
# multiple category is not supported
category: auto generated
# multiple tag entries are possible
tags: [Http, Session]
# thumbnail image for post
img: ":session.jpg"
# disable comments on this page
comments_disable: true

# publish date
date: 2023-04-13 23:50:00 +0900

# seo
# if not specified, date will be used.
#meta_modify_date: 2023-04-13 23:50:00 +0900
# check the meta_common_description in _data/lang/[language].yml
#meta_description: ""

# optional
# if you enabled image_viewer_posts you don't need to enable this. This is only if image_viewer_posts = false
#image_viewer_on: true
# if you enabled image_lazy_loader_posts you don't need to enable this. This is only if image_lazy_loader_posts = false
#image_lazy_loader_on: true
# exclude from on site search
#on_site_search_exclude: true
# exclude from search engines
#search_engine_exclude: true
# to disable this page, simply set published: false or delete this file
#published: false
---
{%- comment -%} Please delete below and place your page content here {%- endcomment -%}

{%- include util/auto-content-generator.liquid -%}

<!-- outline-start -->

# ì„œë¸”ë¦¿ HTTP ì„¸ì…˜1

## âš“ï¸ì„œë¡ 

ì„œë¸”ë¦¿ì€ ì„¸ì…˜ ê¸°ëŠ¥ì„ìœ„í•´ `HttpSession` ì„ ì œê³µí•œë‹¤.

ì•ì—ì„œ ì„¸ì…˜ì„ ì§ì ‘ ë§Œë“¤ì–´ì„œ ì‚¬ìš©í–ˆì§€ë§Œ, ì—¬ê¸°ì„œëŠ” `HttpSession`ì„ ì‚¬ìš©í•˜ë©´ ê³ ìƒì„ ëœì–´ì¤€ë‹¤.

ì§ì ‘ êµ¬í˜„í•œ ê²ƒë³´ë‹¤ ë” ì¢‹ë‹¤.

---

## HttpSession

ì„œë¸”ë¦¿ì—ì„œ ì œê³µí•˜ëŠ” `HttpSession` ëŠ” ì•ì„œ í•´ì™”ë˜ `SessionManager` ì™€ ë¹„ìŠ·í•œ ë°©ì‹ìœ¼ë¡œ ë™ì‘í•œë‹¤.

### â¡ï¸SessionManager

- ì„¸ì…˜ ìƒì„± : UUIDê°’ ìƒì„± â†’ SessionStoreì— put â†’ ì¿ í‚¤ ìƒì„±
- ì„¸ì…˜ ì¡°íšŒ
- ì„¸ì…˜ ë§Œë£Œ

```java
@Component
public class SessionManager {
    public static final String SESSION_COOKIE_NAME = "mySessionId";

    private Map<String, Object> sessionStore = new ConcurrentHashMap<>();

    /**
     * ì„¸ì…˜ ìƒì„±
     */
    public void createSession(Object value, HttpServletResponse response) {

        //ì„¸ì…˜ idë¥¼ ìƒì„±í•˜ê³ , ê°’ì„ ì„¸ì…˜ì— ì €ì¥
        String sessionId = UUID.randomUUID().toString(); // UUID ë§Œë“¤ê¸°
        sessionStore.put(sessionId, value);

        //ì¿ í‚¤ ìƒì„±
        Cookie mySessionCookie = new Cookie(SESSION_COOKIE_NAME, sessionId); // Cookie(String name, String value)
        response.addCookie(mySessionCookie); // responseì— ì¿ í‚¤ë¥¼ ë„£ì–´ì¤€ë‹¤.
    }

    /**
     * ì„¸ì…˜ ì¡°íšŒ
     */
    public Object getSession(HttpServletRequest request) {
        Cookie sessionCookie = findCookie(request, SESSION_COOKIE_NAME);
        if (sessionCookie == null) {
            return null;
        }
        return sessionStore.get(sessionCookie.getValue());
    }

    /**
     * ì„¸ì…˜ ë§Œë£Œ
     */
    public void expire(HttpServletRequest request) {
        Cookie sessionCookie = findCookie(request, SESSION_COOKIE_NAME);
        if (sessionCookie != null) {
            sessionStore.remove(sessionCookie.getValue());
        }
    }

    public Cookie findCookie(HttpServletRequest request, String cookieName) {
        if (request.getCookies() == null) {
            return null;
        }

        return Arrays.stream(request.getCookies()) // ë°°ì—´ì„ ìŠ¤íŠ¸ë¦¼ìœ¼ë¡œ ë°”ê¿”ì¤€ë‹¤.
                .filter(cookie -> cookie.getName().equals(cookieName)) //  Loopë¥¼ ëŒë¦¬ë©´ì„œ ì¿ í‚¤ê°€ ê°™ì€ì§€ í™•ì¸
                .findAny()
                .orElse(null);
    }
}
```

### â¡ï¸ìœ„ì™€ ê°™ì€ ë°©ì‹ ë§ê³  ì„œë¸”ë¦¿ì—ì„œ ì œê³µí•˜ëŠ” ë°©ë²•ìœ¼ë¡œ í•˜ê²Œëœë‹¤ë©´?

- `SessionManager`ê°€ ì•„ë‹Œ `HttpSession` ìœ¼ë¡œ ì„¸ì…˜ ê¸°ëŠ¥ êµ¬í˜„

ì„œë¸”ë¦¿ìœ¼ë¡œ ì„¸ì…˜ì„ ìƒì„œì„± ì¿ í‚¤ê°€ ìƒì„±ë˜ëŠ”ë° ì¿ í‚¤ì˜ ì´ë¦„ì€ `JSESSIONID` ì´ê³ , ê°’ì€ ì¶”ì • ë¶ˆê°€ëŠ¥í•œ ëœë¤ ê°’ì´ë‹¤.

> Cookie : JESSIONID = ì¶”ì •ë¶ˆê°€í•œ ëœë¤ê°’
>

- SessionConst : HttpSessionì— ë°ì´í„°ë¥¼ ë³´ê´€í•˜ê³  ì¡°íšŒí•  ë•Œ , ê°™ì€ ì´ë¦„ì´ ì¤‘ë³µ ë˜ì–´ ì‚¬ìš©ë˜ë¯€ë¡œ ìƒìˆ˜ë¥¼ í•˜ë‚˜ ì •ì˜í–ˆë‹¤.

```java
public interface SessionConst {

    String LOGIN_MEMBER = "loginMember";
}
```

- loginController
  - `request.getSession(true)`
    - ì„¸ì…˜ì´ ìˆìœ¼ë©´ ê¸°ì¡´ ì„¸ì…˜ì„ ë°˜í™˜í•œë‹¤.
    - ì„¸ì…˜ì´ ì—†ìœ¼ë©´ ìƒˆë¡œìš´ ì„¸ì…˜ì„ ìƒì„±í•´ì„œ ë°˜í™˜í•œë‹¤.
  - `request.getSession(false)`
    - ì„¸ì…˜ì´ ìˆìœ¼ë©´ ê¸°ì¡´ ì„¸ì…˜ì„ ë°˜í™˜í•œë‹¤.
    - ì„¸ì…˜ì´ ì—†ìœ¼ë©´ ìƒˆë¡œìš´ ì„¸ì…˜ì„ ìƒì„±í•˜ì§€ ì•ŠëŠ”ë‹¤. â†’ `null` ì„ ë°˜í™˜í•œë‹¤.

  - `session.setAttribute(SessionConst.LOGIN_MEMBER, loginMember);`
    - ì„¸ì…˜ì— ë°ì´í„°ë¥¼ ë³´ê´€í•˜ëŠ” ë°©ë²•ì€ `request.setAttribute(...)`ì™€ ë¹„ìŠ·í•˜ë‹¤. í•˜ë‚˜ì˜ ì„¸ì…˜ì— ì—¬ëŸ¬ ê°’ì„ ì €ì¥í•  ìˆ˜ ìˆìŒ.

```java
/**
  * ë¡œê·¸ì¸ ì„¸ì…˜ HttpSessionìœ¼ë¡œ ì²˜ë¦¬í•˜ê¸°
  * @param form
  * @param bindingResult
  * @param request
  * @return
*/
@PostMapping("/login")
public String loginV3(@Valid @ModelAttribute LoginForm form, BindingResult bindingResult, HttpServletRequest request) {
    if (bindingResult.hasErrors()) {
        return "login/loginForm";
    }

    Member loginMember = loginService.login(form.getLoginId(), form.getPassword());
    log.info("login? {}", loginMember);

    if (loginMember == null) {
        bindingResult.reject("loginFail", "ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ë§ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        return "login/loginForm";
    }

    //ë¡œê·¸ì¸ ì„±ê³µ ì²˜ë¦¬

    //ì„¸ì…˜ì´ ìˆìœ¼ë©´ ìˆëŠ” ì„¸ì…˜ ë³€í™˜, ì—†ìœ¼ë©´ ì‹ ê·œ ì„¸ì…˜ ìƒì„±
    HttpSession session = request.getSession(); // ì„¸ì…˜ì„ ìƒì„±í•˜ë ¤ë©´ -> true (defalut)

    //ì„¸ì…˜ì— ë¡œê·¸ì¸ íšŒì› ì •ë³´ ë³´ê´€
    session.setAttribute(SessionConst.LOGIN_MEMBER, loginMember);
    return "redirect:/";
}
```

- logout - ë¡œê·¸ì•„ì›ƒ
  - `invalidate` ëŠ” ì„¸ì…˜ê³¼ ê·¸ ì•ˆì— ë°ì´í„°ë¥¼ ì§€ì›Œì¤€ë‹¤.

```java
/**
 * ë¡œê·¸ì¸ ì²˜ë¦¬ - ì„¸ì…˜ìœ¼ë¡œ ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ (ì„¸ì…˜ ë§Œë£Œ)
 *
 * @param request
 * @return
 */
@PostMapping("/logout")
public String logoutV2(HttpServletRequest request) {
    HttpSession session = request.getSession(false);
    if(session != null){
        session.invalidate();
    }
    return "redirect:/";
}
```

- HomeController
  - `request.getSession(false);` ì„¸ì…˜ì„ ìƒì„±í•  ì˜ë„ê°€ ì—†ê¸° ë–„ë¬¸ì— `false`

```java
@GetMapping("/")
public String homeLoginV3(HttpServletRequest request, Model model) {

    //ì„¸ì…˜ì´ ì—†ìœ¼ë©´ home
    HttpSession session = request.getSession(false); //false ì„¸ì…˜ ì•ˆë§Œë“¤ê¸° ë•Œë¬¸ì—
    if (session == null) {
        return "home";
    }

    Member loginMember = (Member) session.getAttribute(SessionConst.LOGIN_MEMBER);

    //ì„¸ì…˜ì— íšŒì› ë°ì´í„°ê°€ ì—†ìœ¼ë©´ homeí™”ë©´ìœ¼ë¡œ ì´ë™
    if (loginMember == null) {
        return "home";
    }

    //ì„¸ì…˜ì´ ìœ ì§€ë˜ë©´ ë¡œê·¸ì¸ìœ¼ë¡œ ì´ë™
    model.addAttribute("member", loginMember);
    return "loginHome";
}
```

- ê²°ê³¼ - JSESSIONID

<img width="1123" alt="Untitled" src="https://user-images.githubusercontent.com/56623911/231798444-21b27804-c3dc-4d55-8af2-5d8795116ac2.png">


---

## ğŸ“ì°¸ê³ 

- ****[ìŠ¤í”„ë§ MVC 2í¸ - ë°±ì—”ë“œ ì›¹ ê°œë°œ í™œìš© ê¸°ìˆ ](https://www.inflearn.com/course/ìŠ¤í”„ë§-mvc-2/dashboard)****


<!-- outline-end -->
